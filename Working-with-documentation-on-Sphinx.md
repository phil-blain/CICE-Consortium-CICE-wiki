## Getting Started

### What are Sphinx and reStructuredText (RST)?

The CICE and Icepack documentation is written using reStructuredText (RST) markup language. ReStructuredText is a markup language, like HTML, markdown or LaTeX. Sphinx is a python tool for publishing RST documents in other formats such as HTML and PDF. Additional information about using RST and Sphinx are found in the sections below.

### What is expected of *me* when changing the documentation?

We expect that if you need to add or modify documentation that you will be able to modify the RST source files and generate HTML using Sphinx in order to test the HTML generated. We will review the RST and HTML during a Pull Request to verify it is working properly and consistent with the rest of the CICE-Consortium documentation format.

We do not expect you to generate a PDF of your documentation changes and include this as part of a Pull Request. Updated PDF documentation will be generated for each new release. The online HTML documentation, however, will be updated regularly with regular code development workflow. 

### Where are the documentation files kept?

A PDF of the latest release documentation is available in the master branch at /doc/CICE-Consortium-*.pdf. This document is generated by the CICE-Consortium team and will be updated with releases. The HTML on the website will be the latest documentation for the CICE-Consortium and updated more often than the PDF.

The RST source files for generating html are stored in the master branch of the repository under /doc/source/. 

On your local fork, when you modify RST and use it to generate HTML, the HTML files are created in the /doc/build/html/ directory and can be opened locally to be tested as you add to the documentation.

For the CICE-Consortium, the tested and vetted HTML pages brought in through successful Pull Requests are stored in the gh-pages branch of the repository and accessible from the URL to the linked, searchable User's Guide  on the [Main Wiki Page](https://github.com/CICE-Consortium/Icepack/wiki). Note that the gh-pages is an orphan branch (see below for details) of the repository and has *only* the Sphinx generated HTML documentation and nothing else. 

## ReStructuredText (RST)

### Modifying RST files

Open the RST file using a text editor and make the changes necessary. Note that from the User's Guide documentation (see link above) there is a hyperlink called "Show Source" on the left hand column that will show you the RST source code for the HTML you are viewing. This is a good way to see the syntax for tables, equations, linking references, labeling tables or figures, and correctly identifying documentation sections or subsections.

Here are some basic resources for using RST files:
* [RST Primer1](http://www.sphinx-doc.org/en/stable/rest.html) and [RST Primer2](http://docutils.sourceforge.net/docs/user/rst/quickstart.html)
* [RST Syntax](https://wiki.typo3.org/ReST_Syntax)
* [RST tables](http://www.sphinx-doc.org/en/stable/rest.html#tables) - Note that tables can be tricky in Sphinx and we prefer using [comma separated tables](http://docutils.sourceforge.net/docs/ref/rst/directives.html#csv-table) when possible.

## Sphinx

### Software required for Sphinx HTML generation

Install Sphinx on your local machine. See [Sphinx](http://www.sphinx-doc.org/en/stable/) or [Installing Sphinx](http://www.sphinx-doc.org/en/stable/install.html) for details.

The CICE-Consortium uses the following software to get successful Sphinx HTML builds including references:

* python 2.7.11

* Sphinx (1.6.3)

* sphinx-rtd-theme (0.1.9)

* sphinxcontrib-bibtex (0.3.5)

* sphinxcontrib-websupport (1.0.1)

You will need to use the conf.py file associated with the CICE-Consortium. This is found under /doc/source/conf.py and can be checked out of the repository. 

To use linked references within the HTML you will need to have the sphinxcontrib-bibtex package as well as the zreferences.rst and master_list.bib files under /doc/source/ in the master repository. The list of references in master_list.bib is currently ordered sequentially from oldest to newest and alphabetically within a given year. To add references for your documentation, edit the master_list.bib file using the Articles and Books as examples for your addition(s). Please follow the format for ordering the date/alphabetization ad well as including a URL with the document's DOI. 

### Sphinx workflow

Much of this workflow follows the general CICE-Consortium [Git Workflow and Developer's guide](https://docs.google.com/document/d/1rR6WAvZQT9iAMUp-m_HZ06AUCCI19mguFialsMCYs9o/edit#heading=h.ugpwrwa68ov1). 

[Figure 1](https://github.com/ESMCI/cime/wiki/CIME-Git-Workflow) is also a useful visualization for how the process works.

1. Create a personal fork of the code you are modifying. Then create a branch called "documentation" to test just your RST changes without modifying any other part of the code in the repository. Clone this fork to your local machine with Sphinx installation to do the HTML generation and testing.

2. Add CICE-Consortium as upstream source so you can keep your fork updated and make PR easier.

> $git remote add upstream https://github.com/CICE-Consortium/CICE

> $git remote --v (check that your personal fork is the "origin" and that the CICE-Consortium branch is the "upstream")

3. Check your branch and pull upstream changes

> $git status (check available branches from your personal fork)

> $git checkout documentation

> $git pull upstream documentation  (pulls changes from the CICE-Consortium repository to your fork and branch)

4. Update the RST files

> $cd /doc/source/

> $vi FILE.RST  (change RST file)

5. Test HTML

> $ cd ../  (be in the /doc/ directory)

> $make clean (gets rid of old html)

> $make html  (builds HTML into /build/html/ directory. It will also give you errors if there is a problem with the build)

> $open /build/html/FILE.html  (opens the local HTML on your browser for testing)

6. Getting the documentation back to the CICE-Consortium

When you're happy with the HTML you've generated, you need to commit the RST to your personal fork then do a Pull Request to the CICE-Consortium that we will verify has worked properly.

> $ cd /doc/

> $git add *.rst

> $git commit -m "ADD USEFUL MESSAGE HERE"

> $git push origin  (pushes your changes to your local fork)

7. From the GitHub website of your local fork and branch, immediately do a Pull Request to the CICE-Consortium. We will take care of testing and adding changed HTML to the gh-pages orphan branch.

## Other Tips and Tricks

### Converting LaTeX to RST

If you start from a LaTeX (*.tex) document you will need to convert this to the RST format that Sphinx requires. A handy tool to do this is [Pandoc](http://pandoc.org/getting-started.html), which you can install quickly and run from the command line.

Once Pandoc is installed, the basic command line syntax to convert a file is:

> $pandoc NAMEIN.tex -f latex -t rst -s -ou NAMEOUT.rst

The NAMEOUT.rst file can be directly edited for Sphinx. Pandoc does a beautiful job of converting the text, equations, and many tables. However, equation numbering, section linking, references, figures, and some tables required more hands on care
to be sure they render correctly. 

Pandoc requires that the .tex files be in utf-8 encoding. To easily do this open the *.tex
document in Emacs then do ctrl-x ctrl-m f and you will be prompted to enter encoding type. Just
type in utf-8 and hit enter. Then save with ctrl-x ctrl-s . You are done and the document can be
converted with pandoc.

### Converting RST to PDF

Generating a PDF is more complex and currently requires a two-step process. The generation will require recent versions of both LaTeX and Sphinx. From the /doc/ directory do:

> $make latex

> $cd build/latex

> $make

Then search for the *.pdf document created.

### Creating an orphan branch

An orphan branch is a branch that has no history in common with the master repository off of which it was forked. For the CICE-Consortium, the purpose for this is that the HTML pages created by Sphinx will exist in the orphan branch while the source RST code used to create the HTML exists in the master repository. This way changes to the RST go into the evolving repository, but changes to the HTML are isolated to the orphan branch. This method avoids conflicts related to the HTML that aren’t always caught by GitHub merges and could cause the documentation to break.

Steps to create orphan branch:
1. On GitHub website create personal fork of the repo you’re interested in
2. On GitHub website from your fork, get link for the repository
3. On local machine:

> $git clone URL

> $git branch --l

> $git checkout --orphan gh-pages  (this creates the orphan branch gh-pages from the master branch. The branch should initially have all documents from the master).

> $git remote add upstream URL  (add the URL for the original repository as your “upstream” repository. Get this from Github website)

> $git rm -rf .  (removes everything in this repository. i.e. we are making it so their histories diverge)
 
> $git status .   (check if all the files are gone)

> $ git commit -m “Initial commit to create gh-pages branch of repo”

> $git remote --v  (provides list of remote repositories and links. Should show your personal fork as “origin” and the original repository as "upstream")

> $git push origin gh-pages  (adds the orphan branch, named gh-pages, to your local fork but not the original repo from which you forked)

4. Once you've created the gh-pages branch on your personal fork do a pul request to incorporate the new branch into the master repository. This way someone else will review what you've done and make sure you don't delete an entire repository by accident. It is possible to push the gh-pages branch upstream if you have owner status. Be very careful if you do this.

5. If you set up a new orphan branch you will need to set up Sphinx stuff for it in the master branch. 

> $cd doc

> $mkdir source

> $sphinx-quickstart (This will prompt an interactive options to choose from to create a conf.py file. Note that the conf.py file can be changed later on)

> $cp .gitignore from CICE-Consortium CICE or Icepack master repository. Make sure it will ignore HTML and Emacs back up files (*~) during commits and pushes. 

> $git add .  (should show conf.py, .gitignore)

> $git commit -m “Initial setup for Sphinx documentation”

Do a pull request to add these to the master repository.

